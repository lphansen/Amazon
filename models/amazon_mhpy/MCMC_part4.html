

<!DOCTYPE html>


<html lang="en" data-content_root="" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>Multivariate Normal Log Probability &#8212; My sample book</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=bd9e20870c6007c4c509" rel="stylesheet" />
<link href="../../_static/styles/bootstrap.css?digest=bd9e20870c6007c4c509" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=bd9e20870c6007c4c509" rel="stylesheet" />

  
  <link href="../../_static/vendor/fontawesome/6.5.1/css/all.min.css?digest=bd9e20870c6007c4c509" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.1/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.1/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.1/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" href="../../_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=bd9e20870c6007c4c509" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=bd9e20870c6007c4c509" />
  <script src="../../_static/vendor/fontawesome/6.5.1/js/all.min.js?digest=bd9e20870c6007c4c509"></script>

    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/clipboard.min.js"></script>
    <script src="../../_static/copybutton.js"></script>
    <script src="../../_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../../_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../../_static/sphinx-thebe.js"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'models/amazon_mhpy/MCMC_part4';</script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a id="pst-skip-link" class="skip-link" href="#main-content">Skip to main content</a>
  
  <div id="pst-scroll-pixel-helper"></div>

  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>
    Back to top
  </button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <header>
  
    <div class="bd-header navbar navbar-expand-lg bd-navbar">
    </div>
  
  </header>

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
        
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  

<a class="navbar-brand logo" href="../../intro.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../../_static/mfr.png" class="logo__image only-light" alt="My sample book - Home"/>
    <script>document.write(`<img src="../../_static/mfr.png" class="logo__image only-dark" alt="My sample book - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../../intro.html">
                    Introduction
                </a>
            </li>
        </ul>
        <ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../calibration/calibration.html">Data calibration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Deterministic.html">The case without stochasticity or ambiguity aversion</a></li>
<li class="toctree-l1"><a class="reference internal" href="../HMC.html">Uncertainty in parameters</a></li>




<li class="toctree-l1"><a class="reference internal" href="../MPC.html">Uncertainty in agricultural price</a></li>



</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/executablebooks/jupyter-book" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/executablebooks/jupyter-book/issues/new?title=Issue%20on%20page%20%2Fmodels/amazon_mhpy/MCMC_part4.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../../_sources/models/amazon_mhpy/MCMC_part4.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Multivariate Normal Log Probability</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#">Multivariate Normal Log Probability</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#load-site-data-function">Load Site Data Function</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#log-density-function">Log Density Function</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#description-of-the-main-function">Description of the <code class="docutils literal notranslate"><span class="pre">main</span></code> Function</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#parameters-of-the-function">Parameters of the Function</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#core-function-logic">Core Function Logic</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#hamiltonian-monte-carlo">Hamiltonian Monte Carlo</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#plot-results">Plot Results</a></li>
</ul>
</li>
</ul>

            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python</span>

<span class="c1"># Import Required Packages</span>
<span class="c1"># ========================</span>
<span class="kn">import</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">pickle</span>

<span class="kn">import</span> <span class="nn">casadi</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">scipy</span> <span class="k">as</span> <span class="nn">sp</span>

<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="s2">&quot;mcmc&quot;</span><span class="p">))</span>
<span class="kn">from</span> <span class="nn">mcmc_sampling</span> <span class="kn">import</span> <span class="n">create_hmc_sampler</span>

<span class="c1"># Local Debugging flag; remove when all tested</span>
<span class="n">_DEBUG</span> <span class="o">=</span> <span class="kc">False</span> 
</pre></div>
</div>
</div>
</div>
<p>We investigate a static formulation of robustness to parameter uncertainty.  For each site, we consider the parameter pair <span class="math notranslate nohighlight">\(\beta^i = (\gamma^i, \theta^i)\)</span> for <span class="math notranslate nohighlight">\(i=1,2,...,I.\)</span> Let
<span class="math notranslate nohighlight">\(\mathbf{\beta}\)</span> denote full parameter vector including all sites and hence of dimension <span class="math notranslate nohighlight">\(2 \times I.\)</span></p>
<p>Our planner is uncertain about these parameter values and instead has baseline
probability distribution <span class="math notranslate nohighlight">\(\pi.\)</span>  In addition, this planner is uncertain about what  distribution to use and instead  thinks of <span class="math notranslate nohighlight">\(\pi\)</span> as a rough approximation.  We address this uncertainty by
introducing ambiguity about the parameter distribution.</p>
<p>Let <span class="math notranslate nohighlight">\(d\)</span> be the vector of decisions and <span class="math notranslate nohighlight">\(f( \mathbf{d},\mathbf{\beta})\)</span> for the resulting value  given the unknown parameter <span class="math notranslate nohighlight">\(\mathbf{\beta}.\)</span>  We use a divergence measure to capture  ambiguity about the parameter distribution.  For <span class="math notranslate nohighlight">\(\int g( \mathbf{\beta}) d\pi( \mathbf{\beta}) = 1,\)</span> the relative entropy (or Kullback-Leibler) divergence</p>
<div class="math notranslate nohighlight">
\[
\int_{\mathcal B} \log g(\mathbf{\beta}) g( \mathbf{\beta}) d \pi(\mathbf{ \beta}) \ge 0,  
\]</div>
<p>is a commonly used measure of divergence between a probability <span class="math notranslate nohighlight">\(g(\beta)  d\pi(  \beta)\)</span> and the baseline <span class="math notranslate nohighlight">\(d\pi(\beta).\)</span>
To produce optimal controls that are robust to the parameter uncertainty, solve</p>
<div class="math notranslate nohighlight">
\[
\max_{ d} \min_{g, \int g d\pi = 1} \int_{\mathcal B} f(\mathbf{ d},  \mathbf{ \beta} )   g(\mathbf{ \beta}) d\pi( \mathbf{\beta}) 
+ \xi \int \log g( \mathbf{\beta}) g(\mathbf{ \beta} ) d\pi( \mathbf{\beta}) 
\]</div>
<p>where <span class="math notranslate nohighlight">\(\xi &gt; 0\)</span> is penalty parameter.\footnote{Alternatively, we can think of <span class="math notranslate nohighlight">\(\xi\)</span> a as Lagrange multiplier on a relative entropy divergence constraint.}
\end{problem}</p>
<p>We implement a full commitment to the baseline distribution by  making <span class="math notranslate nohighlight">\(\xi\)</span>  arbitrarily large.  More modest settings capture a concern for robustness.</p>
<p>One nice feature of using relative entropy divergence to explore distributional sensitivity is that the minimization problem has a quasi-analytical solution:</p>
<div class="math notranslate nohighlight">
\[
-\xi \log \int_{\mathcal B} \exp\left[ - {\frac 1 \xi } f(\mathbf{ d},  \mathbf{ \beta} )  \right]  d\pi( \beta) = \min_{g, \int g d\pi = 1} \int_{\mathcal B} f(\mathbf{ d},  \mathbf{ \beta} )   g(\mathbf{ \beta}) d\pi(\mathbf {\beta}) 
+ \xi \int \log g(\mathbf{ \beta}) g( \mathbf{\beta}) d\pi( \mathbf{\beta})
\]</div>
<p>where the minimizing <span class="math notranslate nohighlight">\(g\)</span> given by:</p>
<div class="math notranslate nohighlight">
\[
g^* = \frac {{\exp\left[ - {\frac 1 \xi } f(\mathbf{d},  \mathbf{\beta} )\right]}}
{{\int_{\mathcal B} \exp\left[ - {\frac 1 \xi } f(\mathbf{d}, \tilde  {\mathbf{\beta}})\right]d\pi( \tilde {\mathbf{\beta}} )}}
\]</div>
<p>This tilts the distribution towards smaller objectives for each given decision <span class="math notranslate nohighlight">\(\mathbf{d}\)</span>. The candidate solution presumes that:</p>
<div class="math notranslate nohighlight">
\[
\int_{\mathcal B} \exp\left[ - {\frac 1 \xi } f(\mathbf{d},  \mathbf{\beta})\right]d\pi(\mathbf{\beta} ) &lt; \infty
\]</div>
<p>which implicitly limits how fat the tail can be for the distribution <span class="math notranslate nohighlight">\(\pi\)</span>.</p>
<p><strong>Remark:</strong></p>
<p>The formula on the left-side of equation \eqref is a special case of a smooth ambiguity objective, first suggested by \cite.  They deduced a rationale for an ambiguity adjustment represented using  a concave function distinct from the one used for expressing risk aversion.  Thus the negative exponential in equation \eqref is such a concave function.   The logarithmic adjustment converts this to a certainty equivalent. Their axiomatic motivation is quite different from the distributional robustness that is of interest to us, however.</p>
<p>For conceptual reasons, we also switch the order of the maximization and minimization.  Under quite general conditions, we can invoke the min-max theorem:</p>
<div class="math notranslate nohighlight">
\[
\begin{{problem}} \label{{prob:reverse}}
\min_{g, \int g d\pi = 1} \max_{\mathbf{d}}  \int_{\mathcal B} f(\mathbf{d},  \mathbf{\beta} )   g(\mathbf{\beta}) d\pi(\mathbf{\beta}) 
+ \xi \int \log g(\mathbf{\beta}) g(\mathbf{\beta}) d\pi(\mathbf{\beta}) 
\text{{where }} \xi &gt; 0 \text{{ is penalty parameter.}}
\end{{problem}}
\]</div>
<p>Consider the inner maximization problem:</p>
<div class="math notranslate nohighlight">
\[
\max_{\mathbf{d}}  \int_{\mathcal B} f(\mathbf{d},  \mathbf{\beta} )   g(\mathbf{\beta}) d\pi(\mathbf{\beta})
\]</div>
<p>where we are free to drop the relative entropy penalty as it does not depend on the decision <span class="math notranslate nohighlight">\(\mathbf{d}\)</span>.  Provided that this problem has a solution for the outer <span class="math notranslate nohighlight">\(g\)</span> minimization, then the planner is maximizing against this particular (penalized) “worst case probability.”</p>
<p>This computation is of interest as a way to interpret the consequences of any given choice of the penalty parameter <span class="math notranslate nohighlight">\(\xi\)</span>.  In practice, we find it revealing to explore alternative choices of <span class="math notranslate nohighlight">\(\xi\)</span> and deduce their implications for the implied worst case probabilities.\footnote</p>
<p>For solving the robust problem numerically, we take an iterative approach, also supported by the min-max theorem.</p>
<p>Specifically, we proceed as follows:</p>
<ol class="arabic simple">
<li><p>Given a <span class="math notranslate nohighlight">\(g\)</span>, we solve the maximization problem for a candidate <span class="math notranslate nohighlight">\(\mathbf{d}.\)</span>  We ignore the relative entropy penalty term in this solution.</p></li>
<li><p>For a given <span class="math notranslate nohighlight">\(\mathbf{d}\)</span>, we solve the minimization problem with the relative entropy term to obtain a new  candidate for <span class="math notranslate nohighlight">\(g\)</span>.</p></li>
<li><p>We repeat the steps until we achieve  convergence.</p></li>
</ol>
<p>For step 2, we use a Hamiltonian simulation approach along with the quasi-analytical solution in computing equation \eqref.  A numerical method is necessary because of the denominator term, and Markov simulation gives us one way to explore a parameter space of potentially large dimension.  Very similar to how a Metropolis-Hastings algorithm can be used  to compute a Bayesian posterior in terms of a prior and a likelihood, we calculate the exponentially tilted solution using <span class="math notranslate nohighlight">\(d\pi(\mathbf{\beta})\)</span> and <span class="math notranslate nohighlight">\(\exp\left[-{\frac 1 \xi} f(\mathbf{d}, \mathbf{\beta})\right].\)</span></p>
<section class="tex2jax_ignore mathjax_ignore" id="multivariate-normal-log-probability">
<h1>Multivariate Normal Log Probability<a class="headerlink" href="#multivariate-normal-log-probability" title="Permalink to this heading">#</a></h1>
<p>The function <code class="docutils literal notranslate"><span class="pre">multivariate_normal_log_probability(z,</span> <span class="pre">mean,</span> <span class="pre">cov)</span></code> calculates and returns the log-probability of a (unnormalized) multivariate normal distribution. The parameters of the function are:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">z</span></code> : The value of the multivariate normal random variable.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">mean</span></code> : A one-dimensional array or list that represents the mean of the normal distribution.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">cov</span></code> : A two-dimensional array that represents the covariance matrix.</p></li>
</ul>
<p>This function works by first converting all input parameters into NumPy arrays of floating point numbers. It also flattens the <code class="docutils literal notranslate"><span class="pre">z</span></code> and <code class="docutils literal notranslate"><span class="pre">mean</span></code> arrays to ensure they’re one-dimensional.</p>
<p>The function then performs assertions to verify that the input shapes and types are correct. The size of the <code class="docutils literal notranslate"><span class="pre">mean</span></code> array should be equal to the size of <code class="docutils literal notranslate"><span class="pre">z</span></code>. If <code class="docutils literal notranslate"><span class="pre">mean</span></code> has more than one element, the shape of <code class="docutils literal notranslate"><span class="pre">cov</span></code> should be a square matrix (z.size x z.size). If <code class="docutils literal notranslate"><span class="pre">mean</span></code> has only one element, <code class="docutils literal notranslate"><span class="pre">cov</span></code> should be a single number, which is then reshaped into a 1x1 matrix.</p>
<p>The log-probability of the (unnormalized) multivariate normal distribution is then calculated as follows:</p>
<ol class="arabic simple">
<li><p>Calculate the deviation <code class="docutils literal notranslate"><span class="pre">dev</span></code> from the <code class="docutils literal notranslate"><span class="pre">mean</span></code>.</p></li>
<li><p>Scale the deviation <code class="docutils literal notranslate"><span class="pre">scld_dev</span></code> by the inverse of the covariance matrix.</p></li>
<li><p>Compute the log probability <code class="docutils literal notranslate"><span class="pre">log_prob</span></code> as -0.5 times the dot product of the deviation and the scaled deviation.</p></li>
</ol>
<p>The function finally returns the computed log probability.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">multivariate_normal_log_probability</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">mean</span><span class="p">,</span> <span class="n">cov</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Evaluate and return the log-probability of a (unnormalized) multivariate normal distribution.</span>

<span class="sd">    :param z: value of the multivariate normal random variable</span>
<span class="sd">    :param mean: (1d array/list); mean of the normal distribution</span>
<span class="sd">    :param cov: (2D array) covariance matrix</span>

<span class="sd">    :returns: log-probability of a (unnormalized) multivariate normal distribution</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">z</span>    <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    <span class="n">mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    <span class="n">cov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">cov</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>

    <span class="c1"># Assert/Check input types/shapes</span>
    <span class="k">assert</span> <span class="n">mean</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="n">z</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="s2">&quot;mismatch between variable and mean sizes/shapes&quot;</span>
    <span class="k">if</span> <span class="n">mean</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">cov</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="n">z</span><span class="o">.</span><span class="n">size</span><span class="p">,</span><span class="n">z</span><span class="o">.</span><span class="n">size</span><span class="p">),</span> <span class="s2">&quot;mismatch between variable and covariances `cov` shape&quot;</span>

    <span class="k">elif</span> <span class="n">mean</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">cov</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;mismatch between variable and covariances `cov` shape&quot;</span>
        <span class="n">cov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">cov</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Invalid covariance matrix shape!&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">AssertionError</span>

    <span class="c1"># Evaluate the log-probability</span>
    <span class="n">dev</span>      <span class="o">=</span> <span class="n">z</span> <span class="o">-</span> <span class="n">mean</span>
    <span class="n">scld_dev</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">cov</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span>
    <span class="n">log_prob</span> <span class="o">=</span> <span class="o">-</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">scld_dev</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">log_prob</span>
</pre></div>
</div>
</div>
</div>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="load-site-data-function">
<h1>Load Site Data Function<a class="headerlink" href="#load-site-data-function" title="Permalink to this heading">#</a></h1>
<p>The function <code class="docutils literal notranslate"><span class="pre">load_site_data(site_num,</span> <span class="pre">norm_fac=1.0)</span></code> is designed to load and preprocess site-specific data. The function takes two parameters:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">site_num</span></code> : An integer representing the site number.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">norm_fac</span></code> : A float representing the normalization factor. Its default value is 1.0.</p></li>
</ul>
<p>The function starts by reading a CSV file specific to the site number passed as the <code class="docutils literal notranslate"><span class="pre">site_num</span></code> parameter. The file should be named as “calibration_{n}SitesModel.csv”, where <code class="docutils literal notranslate"><span class="pre">{n}</span></code> is the site number.</p>
<p>The function then extracts information from several columns in the data frame. The columns are named using the site number and the corresponding information type (e.g., <code class="docutils literal notranslate"><span class="pre">z_2017_{n}Sites</span></code>, <code class="docutils literal notranslate"><span class="pre">zbar_2017_{n}Sites</span></code>, etc.).</p>
<p>The extracted information includes:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">z_2017</span></code> : Data specific to the site from 2017.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">zbar_2017</span></code> : Mean data specific to the site from 2017.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">gamma</span></code> : Gamma value for the site.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">gammaSD</span></code> : Standard deviation of the gamma value for the site.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">forestArea_2017_ha</span></code> : Forest area for the site in 2017 (in hectares).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">theta</span></code> : Theta value for the site.</p></li>
</ul>
<p>After extracting the data, the function normalizes <code class="docutils literal notranslate"><span class="pre">zbar_2017</span></code> and <code class="docutils literal notranslate"><span class="pre">z_2017</span></code> using the normalization factor <code class="docutils literal notranslate"><span class="pre">norm_fac</span></code>.</p>
<p>Finally, the function returns a tuple containing the normalized <code class="docutils literal notranslate"><span class="pre">zbar_2017</span></code>, <code class="docutils literal notranslate"><span class="pre">gamma</span></code>, <code class="docutils literal notranslate"><span class="pre">gammaSD</span></code>, <code class="docutils literal notranslate"><span class="pre">z_2017</span></code>, <code class="docutils literal notranslate"><span class="pre">forestArea_2017_ha</span></code>, and <code class="docutils literal notranslate"><span class="pre">theta</span></code> data.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">site_num</span> <span class="o">=</span> <span class="mi">25</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">load_site_data</span><span class="p">(</span><span class="n">site_num</span><span class="p">,</span> 
                   <span class="n">norm_fac</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
                  <span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Load site data</span>

<span class="sd">    :returns:</span>
<span class="sd">        -</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Read data file</span>
    <span class="n">n</span><span class="o">=</span><span class="n">site_num</span>
    <span class="n">file</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;data/calibration_</span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s2">SitesModel.csv&quot;</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>

    
    <span class="c1"># Extract information</span>
    <span class="n">z_2017</span>             <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;z_2017_</span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s1">Sites&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
    <span class="n">zbar_2017</span>          <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;zbar_2017_</span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s1">Sites&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
    <span class="n">gamma</span>              <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;gamma_</span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s1">Sites&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
    <span class="n">gammaSD</span>            <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;gammaSD_</span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s1">Sites&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
    <span class="n">forestArea_2017_ha</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;forestArea_2017_ha_</span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s1">Sites&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
    <span class="n">theta</span>              <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;theta_</span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s1">Sites&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>

    <span class="c1"># Normalize Z data</span>
    <span class="n">zbar_2017</span> <span class="o">/=</span> <span class="n">norm_fac</span>
    <span class="n">z_2017</span>    <span class="o">/=</span> <span class="n">norm_fac</span>
    
    <span class="k">return</span> <span class="p">(</span><span class="n">zbar_2017</span><span class="p">,</span>
            <span class="n">gamma</span><span class="p">,</span>
            <span class="n">gammaSD</span><span class="p">,</span>
            <span class="n">z_2017</span><span class="p">,</span>
            <span class="n">forestArea_2017_ha</span><span class="p">,</span>
            <span class="n">theta</span>
            <span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Verbose Data check (eyeball check!)</span>
<span class="n">zbar_2017</span><span class="p">,</span> <span class="n">gamma</span><span class="p">,</span> <span class="n">gammaSD</span><span class="p">,</span> \
            <span class="n">z_2017</span><span class="p">,</span> <span class="n">forestArea_2017_ha</span><span class="p">,</span> <span class="n">theta</span> <span class="o">=</span> <span class="n">load_site_data</span><span class="p">(</span><span class="n">site_num</span><span class="p">,</span><span class="n">norm_fac</span><span class="o">=</span><span class="mf">1e+9</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;gamma&quot;</span><span class="p">,</span> <span class="n">gamma</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;gammaSD&quot;</span><span class="p">,</span> <span class="n">gammaSD</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;z_2017&quot;</span><span class="p">,</span> <span class="n">z_2017</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;gamma - gammaSD&quot;</span><span class="p">,</span> <span class="n">gamma</span> <span class="o">-</span> <span class="n">gammaSD</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;zbar_2017&quot;</span><span class="p">,</span> <span class="n">zbar_2017</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>gamma [516.88557127 488.95668786 535.7933372  614.38476229 697.34085963
 594.38440765 540.18969668 502.09011583 586.13789618 622.92870153
 468.53543538 216.29945459 736.1126944  644.37719596 568.13204882
 618.56342492 570.93769461 376.7589174  806.29456683 649.96115287
 577.10631912 455.99483831 366.09394675 337.21852297 287.82630347]
gammaSD [22.01380318 12.30650843 23.34479384 32.19887999 33.0552216  20.86507363
 10.44879734  7.97210675 16.35650086 18.89356099  5.66673842  4.7426229
 27.52295223 16.35653107 10.55158851 21.85866557 24.68789648  7.04434639
 35.21752443 25.01272143 13.69821009  6.68635044  1.78628409 14.31382086
 17.20154406]
z_2017 [5.77092940e-07 5.58918518e-06 7.87674083e-04 9.64686174e-06
 1.28634503e-04 1.62486537e-05 7.71270596e-05 4.13615376e-04
 1.41563731e-03 2.97549040e-03 7.91141025e-03 3.11951500e-04
 4.91859804e-04 5.48889538e-04 1.19367249e-03 1.41661798e-03
 6.05514368e-03 6.74644202e-03 8.44104902e-05 2.44820053e-03
 7.38590342e-03 8.45649924e-03 5.22554843e-03 8.60690505e-04
 2.31193733e-03]
gamma - gammaSD [494.87176808 476.65017943 512.44854336 582.1858823  664.28563803
 573.51933402 529.74089934 494.11800908 569.78139532 604.03514054
 462.86869696 211.55683169 708.58974217 628.02066489 557.58046031
 596.70475936 546.24979813 369.71457101 771.0770424  624.94843144
 563.40810902 449.30848787 364.30766265 322.90470211 270.62475941]
zbar_2017 [0.00082784 0.00592396 0.0162693  0.00831711 0.01149272 0.00364199
 0.02794187 0.02603153 0.02649412 0.02588343 0.01898131 0.00098645
 0.02398373 0.02837916 0.02750545 0.0280807  0.0275304  0.00982846
 0.00437791 0.00834653 0.0212187  0.02077097 0.01650749 0.00157716
 0.00345833]
</pre></div>
</div>
</div>
</div>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="log-density-function">
<h1>Log Density Function<a class="headerlink" href="#log-density-function" title="Permalink to this heading">#</a></h1>
<p>The function <code class="docutils literal notranslate"><span class="pre">log_density_function()</span></code> evaluates the log-density of the objective or posterior distribution. This function is used within an optimization loop, with some parameters updated in each iteration of the loop.</p>
<p>The function takes a large number of parameters, some of which include:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">gamma_val</span></code> : Gamma values.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">gamma_vals_mean</span></code> : Mean of gamma values.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">theta_vals</span></code> : Theta values.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">site_precisions</span></code> : Precision of site data.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">alpha</span></code> : Alpha values.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">sol</span></code> : Solution values from optimization.</p></li>
<li><p>And several other parameters.</p></li>
</ul>
<p>Inside the function, the <code class="docutils literal notranslate"><span class="pre">gamma_val</span></code> is flattened and a few initial computations are made. <code class="docutils literal notranslate"><span class="pre">X_zero</span></code> is calculated using <code class="docutils literal notranslate"><span class="pre">gamma_val</span></code>, <code class="docutils literal notranslate"><span class="pre">forestArea_2017_ha</span></code>, and <code class="docutils literal notranslate"><span class="pre">norm_fac</span></code>. <code class="docutils literal notranslate"><span class="pre">X_dym</span></code> is calculated using <code class="docutils literal notranslate"><span class="pre">alpha_p_Adym</span></code>, <code class="docutils literal notranslate"><span class="pre">X_zero</span></code>, <code class="docutils literal notranslate"><span class="pre">Bdym</span></code>, and <code class="docutils literal notranslate"><span class="pre">omega</span></code>.</p>
<p>The function then modifies the solution of <code class="docutils literal notranslate"><span class="pre">X</span></code> (i.e., <code class="docutils literal notranslate"><span class="pre">sol.value(X)</span></code>) for further computation. This modification includes shifting and scaling operations on the <code class="docutils literal notranslate"><span class="pre">X</span></code> matrix.</p>
<p>The function computes the log-density in three steps:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">term_1</span></code> is calculated as the negative sum of the product of <code class="docutils literal notranslate"><span class="pre">ds_vect</span></code>, <code class="docutils literal notranslate"><span class="pre">sol.value(Ua)</span></code>, and <code class="docutils literal notranslate"><span class="pre">zeta</span></code>, all divided by 2.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">term_2</span></code> is computed as the sum of the product of <code class="docutils literal notranslate"><span class="pre">ds_vect</span></code>, <code class="docutils literal notranslate"><span class="pre">pf</span></code>, and the difference between successive elements of <code class="docutils literal notranslate"><span class="pre">X_dym</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">term_3</span></code> is calculated as the sum of the product of <code class="docutils literal notranslate"><span class="pre">ds_vect</span></code> and the sum of <code class="docutils literal notranslate"><span class="pre">z_shifted_X</span></code>.</p></li>
</ul>
<p>The objective value <code class="docutils literal notranslate"><span class="pre">obj_val</span></code> is the sum of <code class="docutils literal notranslate"><span class="pre">term_1</span></code>, <code class="docutils literal notranslate"><span class="pre">term_2</span></code>, and <code class="docutils literal notranslate"><span class="pre">term_3</span></code>.</p>
<p>The function also computes <code class="docutils literal notranslate"><span class="pre">norm_log_prob</span></code> as the negative half of the dot product of <code class="docutils literal notranslate"><span class="pre">gamma_val_dev</span></code> and the dot product of <code class="docutils literal notranslate"><span class="pre">site_precisions</span></code> and <code class="docutils literal notranslate"><span class="pre">gamma_val_dev</span></code>.</p>
<p>The log density value <code class="docutils literal notranslate"><span class="pre">log_density_val</span></code> is calculated as <code class="docutils literal notranslate"><span class="pre">-1.0</span> <span class="pre">/</span> <span class="pre">xi</span> <span class="pre">*</span> <span class="pre">obj_val</span> <span class="pre">+</span> <span class="pre">norm_log_prob</span></code>.</p>
<p>If the global <code class="docutils literal notranslate"><span class="pre">_DEBUG</span></code> flag is set, the function prints out the values of <code class="docutils literal notranslate"><span class="pre">term_1</span></code>, <code class="docutils literal notranslate"><span class="pre">term_2</span></code>, <code class="docutils literal notranslate"><span class="pre">term_3</span></code>, <code class="docutils literal notranslate"><span class="pre">obj_val</span></code>, <code class="docutils literal notranslate"><span class="pre">norm_log_prob</span></code>, and <code class="docutils literal notranslate"><span class="pre">log_density_val</span></code>.</p>
<p>Finally, the function returns the <code class="docutils literal notranslate"><span class="pre">log_density_val</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">log_density_function</span><span class="p">(</span><span class="n">gamma_val</span><span class="p">,</span>
                         <span class="n">gamma_vals_mean</span><span class="p">,</span>
                         <span class="n">theta_vals</span><span class="p">,</span>
                   
                         <span class="n">site_precisions</span><span class="p">,</span>
                         <span class="n">alpha</span><span class="p">,</span>
                         <span class="n">sol</span><span class="p">,</span>
                         <span class="n">X</span><span class="p">,</span>
                         <span class="n">Ua</span><span class="p">,</span>
                         <span class="n">Up</span><span class="p">,</span>
                         <span class="n">zbar_2017</span><span class="p">,</span>
                         <span class="n">forestArea_2017_ha</span><span class="p">,</span>
                         <span class="n">norm_fac</span><span class="p">,</span>
                         <span class="n">alpha_p_Adym</span><span class="p">,</span>
                         <span class="n">Bdym</span><span class="p">,</span>
                         <span class="n">leng</span><span class="p">,</span>
                         <span class="n">T</span><span class="p">,</span>
                         <span class="n">ds_vect</span><span class="p">,</span>
                         <span class="n">zeta</span><span class="p">,</span>
                         <span class="n">xi</span><span class="p">,</span>
                         <span class="n">kappa</span><span class="p">,</span>
                         <span class="n">pa</span><span class="p">,</span>
                         <span class="n">pf</span><span class="p">,</span>
                         <span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Define a function to evaluate log-density of the objective/posterior distribution</span>
<span class="sd">    Some of the input parameters are updated at each cycle of the outer loop (optimization loop),</span>
<span class="sd">    and it becomes then easier/cheaper to udpate the function stamp and keep it separate here</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">N</span>          <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
    
    <span class="n">gamma_val</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">gamma_val</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    <span class="n">gamma_size</span> <span class="o">=</span> <span class="n">gamma_val</span><span class="o">.</span><span class="n">size</span>
    <span class="n">x0_vals</span>    <span class="o">=</span> <span class="n">gamma_val</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">forestArea_2017_ha</span><span class="p">)</span> <span class="o">/</span> <span class="n">norm_fac</span>
    <span class="n">X_zero</span>     <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">x0_vals</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">leng</span><span class="p">)</span>
    
    
    <span class="c1"># shifted_X = zbar_2017 - sol.value(X)[0:gamma_size, :-1]</span>
    <span class="n">shifted_X</span>  <span class="o">=</span> <span class="n">sol</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">X</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span> <span class="n">gamma_size</span><span class="p">,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span> 
        <span class="n">shifted_X</span><span class="p">[:,</span> <span class="n">j</span><span class="p">]</span>  <span class="o">=</span> <span class="n">zbar_2017</span> <span class="o">-</span> <span class="n">shifted_X</span><span class="p">[:,</span> <span class="n">j</span><span class="p">]</span>
    <span class="n">omega</span>      <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">gamma_val</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">*</span> <span class="n">shifted_X</span> <span class="o">-</span> <span class="n">sol</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">Up</span><span class="p">))</span>
    
    <span class="n">X_dym</span>      <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">T</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">X_dym</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">x0_vals</span><span class="p">)</span>
    <span class="n">X_dym</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span> <span class="p">]</span> <span class="o">=</span> <span class="n">alpha_p_Adym</span> <span class="o">*</span> <span class="n">X_zero</span>  <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Bdym</span><span class="p">,</span> <span class="n">omega</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>

    <span class="n">z_shifted_X</span> <span class="o">=</span> <span class="n">sol</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">X</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span> <span class="n">gamma_size</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">scl</span> <span class="o">=</span> <span class="n">pa</span> <span class="o">*</span> <span class="n">theta_vals</span> <span class="o">-</span> <span class="n">pf</span> <span class="o">*</span> <span class="n">kappa</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span> <span class="n">z_shifted_X</span> <span class="p">[:,</span> <span class="n">j</span><span class="p">]</span> <span class="o">*=</span> <span class="n">scl</span>
    
    <span class="n">term_1</span> <span class="o">=</span> <span class="o">-</span> <span class="n">casadi</span><span class="o">.</span><span class="n">sum2</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">ds_vect</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span> <span class="n">T</span><span class="p">],</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">T</span><span class="p">))</span> <span class="o">*</span> <span class="n">sol</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">Ua</span><span class="p">)</span> <span class="o">*</span> <span class="n">zeta</span> <span class="o">/</span> <span class="mi">2</span> <span class="p">)</span>
    <span class="n">term_2</span> <span class="o">=</span> <span class="n">casadi</span><span class="o">.</span><span class="n">sum2</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">ds_vect</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span> <span class="n">T</span><span class="p">],</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">T</span><span class="p">))</span> <span class="o">*</span> <span class="n">pf</span> <span class="o">*</span> <span class="p">(</span><span class="n">X_dym</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span> <span class="p">]</span> <span class="o">-</span> <span class="n">X_dym</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">term_3</span> <span class="o">=</span> <span class="n">casadi</span><span class="o">.</span><span class="n">sum2</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">ds_vect</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">N</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span> <span class="o">*</span> <span class="n">casadi</span><span class="o">.</span><span class="n">sum1</span><span class="p">(</span><span class="n">z_shifted_X</span><span class="p">))</span>
    
    <span class="n">obj_val</span> <span class="o">=</span> <span class="n">term_1</span> <span class="o">+</span> <span class="n">term_2</span> <span class="o">+</span> <span class="n">term_3</span>
    
    <span class="n">gamma_val_dev</span>   <span class="o">=</span> <span class="n">gamma_val</span> <span class="o">-</span> <span class="n">gamma_vals_mean</span>
    <span class="n">norm_log_prob</span>   <span class="o">=</span>   <span class="o">-</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">gamma_val_dev</span><span class="p">,</span>
                                       <span class="n">site_precisions</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">gamma_val_dev</span><span class="p">)</span>
                                       <span class="p">)</span>
    <span class="n">log_density_val</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span>  <span class="o">/</span> <span class="n">xi</span> <span class="o">*</span> <span class="n">obj_val</span> <span class="o">+</span> <span class="n">norm_log_prob</span>

    <span class="k">if</span> <span class="n">_DEBUG</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Term 1: &quot;</span><span class="p">,</span> <span class="n">term_1</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Term 2: &quot;</span><span class="p">,</span> <span class="n">term_2</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Term 3: &quot;</span><span class="p">,</span> <span class="n">term_3</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;obj_val: &quot;</span><span class="p">,</span> <span class="n">obj_val</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;norm_log_prob&quot;</span><span class="p">,</span> <span class="n">norm_log_prob</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;log_density_val&quot;</span><span class="p">,</span> <span class="n">log_density_val</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">log_density_val</span>
</pre></div>
</div>
</div>
</div>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="description-of-the-main-function">
<h1>Description of the <code class="docutils literal notranslate"><span class="pre">main</span></code> Function<a class="headerlink" href="#description-of-the-main-function" title="Permalink to this heading">#</a></h1>
<p>The <code class="docutils literal notranslate"><span class="pre">main</span></code> function is a complex piece of code that is designed to model and solve an optimization problem using Hamiltonian Monte Carlo (HMC) sampling and the CasADi framework for nonlinear optimization.</p>
<section id="parameters-of-the-function">
<h2>Parameters of the Function<a class="headerlink" href="#parameters-of-the-function" title="Permalink to this heading">#</a></h2>
<p>The function accepts numerous parameters, most of which have default values:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">norm_fac</span></code>, <code class="docutils literal notranslate"><span class="pre">delta_t</span></code>, <code class="docutils literal notranslate"><span class="pre">alpha</span></code>, <code class="docutils literal notranslate"><span class="pre">kappa</span></code>, <code class="docutils literal notranslate"><span class="pre">pf</span></code>, <code class="docutils literal notranslate"><span class="pre">pa</span></code>, <code class="docutils literal notranslate"><span class="pre">xi</span></code>, <code class="docutils literal notranslate"><span class="pre">zeta</span></code>: These seem to be configurations or settings for the model.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">max_iter</span></code>, <code class="docutils literal notranslate"><span class="pre">tol</span></code>, <code class="docutils literal notranslate"><span class="pre">T</span></code>, <code class="docutils literal notranslate"><span class="pre">N</span></code>: These are parameters that control the iterations in the optimization process.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">sample_size</span></code>, <code class="docutils literal notranslate"><span class="pre">mode_as_solution</span></code>, <code class="docutils literal notranslate"><span class="pre">final_sample_size</span></code>: These parameters relate to the sampling process for the Hamiltonian Monte Carlo method.</p></li>
</ul>
</section>
<section id="core-function-logic">
<h2>Core Function Logic<a class="headerlink" href="#core-function-logic" title="Permalink to this heading">#</a></h2>
<p>The function begins by loading data related to the sites and performing some preliminary calculations on gamma values. It then calculates the mean and covariances from the site data. It sets up various data structures and matrices to hold information as it iterates through the main loop.</p>
<p>The main loop is a convergence loop that continues until the maximum number of iterations is reached or the error is below a specified tolerance. In each loop, the function:</p>
<ul class="simple">
<li><p>Updates the values of x0 and constructs matrices A and D using the current gamma values.</p></li>
<li><p>Defines the right-hand side of an equation to be solved by a solver.</p></li>
<li><p>Sets up and solves an optimization problem using the CasADi <code class="docutils literal notranslate"><span class="pre">Opti</span></code> class.</p></li>
<li><p>Generates samples using the Hamiltonian Monte Carlo method. It then updates the gamma values and computes an error metric for convergence.</p></li>
<li><p>If the convergence criterion is met, the function exits the loop, otherwise, it continues to the next iteration.</p></li>
</ul>
<p>The function concludes by sampling the final distribution densely and returning the results.</p>
</section>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="hamiltonian-monte-carlo">
<h1>Hamiltonian Monte Carlo<a class="headerlink" href="#hamiltonian-monte-carlo" title="Permalink to this heading">#</a></h1>
<p>Below is a descirption of the Hamiltonian Monte Carlo</p>
<ol class="arabic simple">
<li><p><strong>Initialization</strong>: Start with an initial guess for <span class="math notranslate nohighlight">\(\beta\)</span>, typically denoted as <span class="math notranslate nohighlight">\(\bar{\beta}\)</span>. Simultaneously, generate a random value for <span class="math notranslate nohighlight">\(\mu\)</span> from its marginal distribution.</p></li>
<li><p><strong>Symplectic Integration</strong>: Use a discrete approximation method that preserves volume (like the Leapfrog method), also known as a symplectic integrator, to simulate the Hamiltonian dynamics. This process involves choosing a step size and running the simulation for a predetermined number of steps, typically around 20 but can be tailored based on the problem at hand. The output from this step is a new proposed point in the parameter space, denoted as <span class="math notranslate nohighlight">\((\beta^*,\mu^*)\)</span>.</p></li>
<li><p><strong>Metropolis Acceptance</strong>: The Metropolis algorithm is then employed to decide whether to accept or reject the proposed point. The acceptance probability is given by <span class="math notranslate nohighlight">\(\min\{1, \exp\left(H(\beta,\mu)-H(\beta^*,\mu^*)\right)\}\)</span>, with discretization allowing for a probability less than 1.</p>
<ul class="simple">
<li><p>It is important to note that the volume-preservation property of the symplectic integrator guarantees that the Metropolis update leaves the canonical distribution for <span class="math notranslate nohighlight">\((\beta, \mu)\)</span> invariant.</p></li>
</ul>
</li>
<li><p><strong>Iteration</strong>: Generate another random value for <span class="math notranslate nohighlight">\(\mu'\)</span> and repeat the steps 2 and 3 starting from the new point <span class="math notranslate nohighlight">\((\beta^*,\mu')\)</span>. If the proposed point is rejected in the Metropolis step, we stick with the current <span class="math notranslate nohighlight">\(\beta\)</span> and repeat the process.</p></li>
<li><p><strong>Decision Recalculation</strong>: After each full iteration, the decision <span class="math notranslate nohighlight">\(d\)</span> is recalculated.</p></li>
<li><p><strong>Convergence</strong>: The process from steps 2 to 5 is repeated until the average <span class="math notranslate nohighlight">\(\beta\)</span> value converges to a stable point.</p></li>
<li><p><strong>Final Distribution</strong>: Lastly, the HMC is run for a large number of iterations (e.g., 10,000) to produce the final distorted distribution. This comprehensive run allows for more robust estimation of the distribution.</p></li>
</ol>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">main</span><span class="p">(</span>
    <span class="c1"># Configurations/Settings</span>
    <span class="n">norm_fac</span>          <span class="o">=</span> <span class="mf">1e9</span><span class="p">,</span>
    <span class="n">delta_t</span>           <span class="o">=</span> <span class="mf">0.02</span><span class="p">,</span>
    <span class="n">alpha</span>             <span class="o">=</span> <span class="mf">0.045007414</span><span class="p">,</span>
    <span class="n">kappa</span>             <span class="o">=</span> <span class="mf">2.094215255</span><span class="p">,</span>
    <span class="n">pf</span>                <span class="o">=</span> <span class="mf">20.76</span><span class="p">,</span>
    <span class="n">pa</span>                <span class="o">=</span> <span class="mf">44.75</span><span class="p">,</span>
    <span class="n">xi</span>                <span class="o">=</span> <span class="mf">0.01</span><span class="p">,</span>
    <span class="n">zeta</span>              <span class="o">=</span> <span class="mf">1.66e-4</span><span class="o">*</span><span class="mf">1e9</span><span class="p">,</span>  <span class="c1"># zeta := 1.66e-4*norm_fac  #</span>
    <span class="c1">#</span>
    <span class="n">max_iter</span>          <span class="o">=</span> <span class="mi">200</span><span class="p">,</span>
    <span class="n">tol</span>               <span class="o">=</span> <span class="mf">0.01</span><span class="p">,</span>
    <span class="n">T</span>                 <span class="o">=</span> <span class="mi">200</span><span class="p">,</span>
    <span class="n">N</span>                 <span class="o">=</span> <span class="mi">200</span><span class="p">,</span>
    <span class="c1">#</span>
    <span class="n">sample_size</span>       <span class="o">=</span> <span class="mi">1000</span><span class="p">,</span>    <span class="c1"># simulations before convergence (to evaluate the mean)</span>
    <span class="n">mode_as_solution</span>  <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>   <span class="c1"># If true, use the mode (point of high probability) as solution for gamma</span>
    <span class="n">final_sample_size</span> <span class="o">=</span> <span class="mi">100_00</span><span class="p">,</span> <span class="c1"># number of samples to collect after convergence</span>
    <span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Main function; putting things together</span>

<span class="sd">    :param float tol: convergence tolerance</span>
<span class="sd">    :param T:</span>
<span class="sd">    :param N:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    

    <span class="c1"># Load sites&#39; data</span>
    <span class="n">zbar_2017</span><span class="p">,</span> <span class="n">gamma</span><span class="p">,</span> <span class="n">gammaSD</span><span class="p">,</span> \
        <span class="n">z_2017</span><span class="p">,</span> <span class="n">forestArea_2017_ha</span><span class="p">,</span> <span class="n">theta</span> \
        <span class="o">=</span> <span class="n">load_site_data</span><span class="p">(</span><span class="n">site_num</span><span class="p">,</span><span class="n">norm_fac</span><span class="o">=</span><span class="n">norm_fac</span><span class="p">)</span>


    <span class="c1"># Evaluate Gamma values ()</span>
    <span class="n">gamma_1_vals</span>  <span class="o">=</span> <span class="n">gamma</span> <span class="o">-</span>  <span class="n">gammaSD</span>
    <span class="n">gamma_2_vals</span>  <span class="o">=</span> <span class="n">gamma</span> <span class="o">+</span>  <span class="n">gammaSD</span>
    <span class="n">gamma_size</span>    <span class="o">=</span> <span class="n">gamma</span><span class="o">.</span><span class="n">size</span>

    <span class="c1"># Evaluate mean and covariances from site data</span>
    <span class="n">site_stdev</span>       <span class="o">=</span> <span class="n">gammaSD</span>
    <span class="n">site_covariances</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">site_stdev</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
    <span class="n">site_precisions</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">site_covariances</span><span class="p">)</span>
    <span class="n">site_mean</span>        <span class="o">=</span> <span class="n">gamma_1_vals</span><span class="o">/</span><span class="mi">2</span> <span class="o">+</span> <span class="n">gamma_2_vals</span><span class="o">/</span><span class="mi">2</span>

    <span class="c1"># Retrieve z data for selected site(s)</span>
    <span class="n">site_z_vals</span>  <span class="o">=</span> <span class="n">z_2017</span>

    <span class="c1"># Initialize Gamma Values</span>
    <span class="n">gamma_vals</span>      <span class="o">=</span> <span class="n">gamma</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">gamma_vals_mean</span> <span class="o">=</span> <span class="n">gamma</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">gamma_vals_old</span>  <span class="o">=</span> <span class="n">gamma</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="c1"># Theta Values</span>
    <span class="n">theta_vals</span>  <span class="o">=</span> <span class="n">theta</span>

    <span class="c1"># Householder to track sampled gamma values</span>
    <span class="c1"># gamma_vals_tracker       = np.empty((gamma_vals.size, sample_size+1))</span>
    <span class="c1"># gamma_vals_tracker[:, 0] = gamma_vals.copy()</span>
    <span class="n">gamma_vals_tracker</span> <span class="o">=</span> <span class="p">[</span><span class="n">gamma_vals</span><span class="o">.</span><span class="n">copy</span><span class="p">()]</span>

    <span class="c1"># Collected Ensembles over all iterations; dictionary indexed by iteration number</span>
    <span class="n">collected_ensembles</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># Track error over iterations</span>
    <span class="n">error_tracker</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># Update this parameter (leng) once figured out where it is coming from</span>
    <span class="n">leng</span> <span class="o">=</span> <span class="mi">200</span>
    <span class="n">arr</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span>
             <span class="n">np</span><span class="o">.</span><span class="n">triu</span><span class="p">(</span>
             <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">leng</span><span class="p">,</span> <span class="n">leng</span><span class="p">))</span>
         <span class="p">),</span>
         <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="p">)</span><span class="o">.</span><span class="n">T</span>
    <span class="n">Bdym</span>         <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">alpha</span><span class="p">)</span> <span class="o">**</span> <span class="p">(</span><span class="n">arr</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">Bdym</span><span class="p">[</span><span class="n">Bdym</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">Adym</span>         <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">leng</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">alpha_p_Adym</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">alpha</span><span class="p">,</span> <span class="n">Adym</span><span class="p">)</span>

    <span class="c1"># Initialize Blocks of the A matrix those won&#39;t change</span>
    <span class="n">A</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">gamma_size</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span> <span class="n">gamma_size</span><span class="o">+</span><span class="mi">2</span><span class="p">))</span>
    <span class="n">Ax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">gamma_size</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span>

    <span class="c1"># Construct Matrix B</span>
    <span class="n">B</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">N</span><span class="o">=</span><span class="n">gamma_size</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span> <span class="n">M</span><span class="o">=</span><span class="n">gamma_size</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">B</span> <span class="o">=</span> <span class="n">casadi</span><span class="o">.</span><span class="n">sparsify</span><span class="p">(</span><span class="n">B</span><span class="p">)</span>

    <span class="c1"># Construct Matrxi D constant blocks</span>
    <span class="n">D</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">gamma_size</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span> <span class="n">gamma_size</span><span class="p">))</span>

    <span class="c1"># time step!</span>
    <span class="n">dt</span> <span class="o">=</span> <span class="n">T</span> <span class="o">/</span> <span class="n">N</span>

    <span class="c1"># Other placeholders!</span>
    <span class="n">ds_vect</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span> <span class="n">delta_t</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">N</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">dt</span><span class="p">)</span>
    <span class="n">ds_vect</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">ds_vect</span><span class="p">,</span> <span class="p">(</span><span class="n">ds_vect</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

    <span class="c1"># Results dictionary</span>
    <span class="n">results</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="n">gamma_size</span><span class="o">=</span><span class="n">gamma_size</span><span class="p">,</span>
        <span class="n">tol</span><span class="o">=</span><span class="n">tol</span><span class="p">,</span>
        <span class="n">T</span><span class="o">=</span><span class="n">T</span><span class="p">,</span>
        <span class="n">N</span><span class="o">=</span><span class="n">N</span><span class="p">,</span>
        <span class="n">norm_fac</span><span class="o">=</span><span class="n">norm_fac</span><span class="p">,</span>
        <span class="n">delta_t</span><span class="o">=</span><span class="n">delta_t</span><span class="p">,</span>
        <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span>
        <span class="n">kappa</span><span class="o">=</span><span class="n">kappa</span><span class="p">,</span>
        <span class="n">pf</span><span class="o">=</span><span class="n">pf</span><span class="p">,</span>
        <span class="n">pa</span><span class="o">=</span><span class="n">pa</span><span class="p">,</span>
        <span class="n">xi</span><span class="o">=</span><span class="n">xi</span><span class="p">,</span>
        <span class="n">zeta</span><span class="o">=</span><span class="n">zeta</span><span class="p">,</span>
        <span class="n">sample_size</span><span class="o">=</span><span class="n">sample_size</span><span class="p">,</span>
        <span class="n">final_sample_size</span><span class="o">=</span><span class="n">final_sample_size</span><span class="p">,</span>
        <span class="n">mode_as_solution</span><span class="o">=</span><span class="n">mode_as_solution</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Initialize error &amp; iteration counter</span>
    <span class="n">error</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">infty</span>
    <span class="n">cntr</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1"># Loop until convergence</span>
    <span class="k">while</span> <span class="n">cntr</span> <span class="o">&lt;</span> <span class="n">max_iter</span> <span class="ow">and</span> <span class="n">error</span> <span class="o">&gt;</span> <span class="n">tol</span><span class="p">:</span>

        <span class="c1"># Update x0</span>
        <span class="n">x0_vals</span> <span class="o">=</span> <span class="n">gamma_vals</span> <span class="o">*</span> <span class="n">forestArea_2017_ha</span> <span class="o">/</span> <span class="n">norm_fac</span>

        <span class="c1"># Construct Matrix A from new gamma_vals</span>
        <span class="n">A</span><span class="p">[:</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="p">:]</span>        <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">Ax</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span> <span class="n">gamma_size</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span> <span class="n">alpha</span> <span class="o">*</span> <span class="n">gamma_vals</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span> <span class="n">gamma_size</span><span class="p">]</span>
        <span class="n">Ax</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>            <span class="o">=</span> <span class="n">alpha</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">gamma_vals</span> <span class="o">*</span> <span class="n">zbar_2017</span><span class="p">)</span>
        <span class="n">Ax</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>            <span class="o">=</span> <span class="o">-</span> <span class="n">alpha</span>
        <span class="n">A</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="p">:]</span>          <span class="o">=</span> <span class="n">Ax</span>
        <span class="n">A</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>          <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">A</span> <span class="o">=</span> <span class="n">casadi</span><span class="o">.</span><span class="n">sparsify</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>

        <span class="c1"># Construct Matrix D from new gamma_vals</span>
        <span class="n">D</span><span class="p">[:,</span> <span class="p">:]</span>  <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">D</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="o">-</span><span class="n">gamma_vals</span>
        <span class="n">D</span> <span class="o">=</span> <span class="n">casadi</span><span class="o">.</span><span class="n">sparsify</span><span class="p">(</span><span class="n">D</span><span class="p">)</span>
        
        <span class="c1"># Define the right hand side (symbolic here) as a function of gamma</span>
        <span class="n">gamma</span> <span class="o">=</span> <span class="n">casadi</span><span class="o">.</span><span class="n">MX</span><span class="o">.</span><span class="n">sym</span><span class="p">(</span><span class="s1">&#39;gamma&#39;</span> <span class="p">,</span> <span class="n">gamma_size</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">up</span>    <span class="o">=</span> <span class="n">casadi</span><span class="o">.</span><span class="n">MX</span><span class="o">.</span><span class="n">sym</span><span class="p">(</span><span class="s1">&#39;up&#39;</span><span class="p">,</span> <span class="n">gamma_size</span><span class="p">)</span>
        <span class="n">um</span>    <span class="o">=</span> <span class="n">casadi</span><span class="o">.</span><span class="n">MX</span><span class="o">.</span><span class="n">sym</span><span class="p">(</span><span class="s1">&#39;um&#39;</span><span class="p">,</span> <span class="n">gamma_size</span><span class="p">)</span>

        <span class="n">rhs</span> <span class="o">=</span> <span class="p">(</span><span class="n">A</span> <span class="o">@</span> <span class="n">gamma</span> <span class="o">+</span> <span class="n">B</span> <span class="o">@</span> <span class="p">(</span><span class="n">up</span><span class="o">-</span><span class="n">um</span><span class="p">)</span> <span class="o">+</span> <span class="n">D</span> <span class="o">@</span> <span class="n">up</span><span class="p">)</span> <span class="o">*</span> <span class="n">dt</span> <span class="o">+</span> <span class="n">gamma</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">casadi</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span><span class="s1">&#39;f&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">gamma</span><span class="p">,</span> <span class="n">um</span><span class="p">,</span> <span class="n">up</span><span class="p">],</span> <span class="p">[</span><span class="n">rhs</span><span class="p">])</span>
        

        <span class="c1">## Define an optimizer and initialize it, and set constraints</span>
        <span class="n">opti</span> <span class="o">=</span> <span class="n">casadi</span><span class="o">.</span><span class="n">Opti</span><span class="p">()</span>

        <span class="c1"># Decision variables for states</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">opti</span><span class="o">.</span><span class="n">variable</span><span class="p">(</span><span class="n">gamma_size</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span> <span class="n">N</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Aliases for states</span>
        <span class="n">Up</span> <span class="o">=</span> <span class="n">opti</span><span class="o">.</span><span class="n">variable</span><span class="p">(</span><span class="n">gamma_size</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>
        <span class="n">Um</span> <span class="o">=</span> <span class="n">opti</span><span class="o">.</span><span class="n">variable</span><span class="p">(</span><span class="n">gamma_size</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>
        <span class="n">Ua</span> <span class="o">=</span> <span class="n">opti</span><span class="o">.</span><span class="n">variable</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>

        <span class="c1"># 1.2: Parameter for initial state</span>
        <span class="n">ic</span> <span class="o">=</span> <span class="n">opti</span><span class="o">.</span><span class="n">parameter</span><span class="p">(</span><span class="n">gamma_size</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span>

        <span class="c1"># Gap-closing shooting constraints</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
            <span class="n">opti</span><span class="o">.</span><span class="n">subject_to</span><span class="p">(</span><span class="n">X</span><span class="p">[:,</span> <span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">f</span><span class="p">(</span><span class="n">X</span><span class="p">[:,</span> <span class="n">k</span><span class="p">],</span> <span class="n">Um</span><span class="p">[:,</span> <span class="n">k</span><span class="p">],</span> <span class="n">Up</span><span class="p">[:,</span> <span class="n">k</span><span class="p">]))</span>

        <span class="c1"># Initial and terminal constraints</span>
        <span class="n">opti</span><span class="o">.</span><span class="n">subject_to</span><span class="p">(</span><span class="n">X</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">ic</span><span class="p">)</span>
        <span class="n">opti</span><span class="o">.</span><span class="n">subject_to</span><span class="p">(</span><span class="n">opti</span><span class="o">.</span><span class="n">bounded</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span>
                                     <span class="n">X</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span> <span class="n">gamma_size</span><span class="p">,</span> <span class="p">:],</span>
                                     <span class="n">zbar_2017</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span> <span class="n">gamma_size</span><span class="p">]</span>
                                     <span class="p">)</span>
                        <span class="p">)</span>

        <span class="c1"># Objective: regularization of controls</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">gamma_size</span><span class="p">):</span>
            <span class="n">opti</span><span class="o">.</span><span class="n">subject_to</span><span class="p">(</span><span class="n">opti</span><span class="o">.</span><span class="n">bounded</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">Um</span><span class="p">[</span><span class="n">k</span><span class="p">,:],</span> <span class="n">casadi</span><span class="o">.</span><span class="n">inf</span><span class="p">))</span>
            <span class="n">opti</span><span class="o">.</span><span class="n">subject_to</span><span class="p">(</span><span class="n">opti</span><span class="o">.</span><span class="n">bounded</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">Up</span><span class="p">[</span><span class="n">k</span><span class="p">,:],</span> <span class="n">casadi</span><span class="o">.</span><span class="n">inf</span><span class="p">))</span>

        <span class="n">opti</span><span class="o">.</span><span class="n">subject_to</span><span class="p">(</span><span class="n">Ua</span> <span class="o">==</span> <span class="n">casadi</span><span class="o">.</span><span class="n">sum1</span><span class="p">(</span><span class="n">Up</span><span class="o">+</span><span class="n">Um</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

        <span class="c1"># Set teh optimization problem</span>
        <span class="n">term1</span> <span class="o">=</span> <span class="n">casadi</span><span class="o">.</span><span class="n">sum2</span><span class="p">(</span><span class="n">ds_vect</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span> <span class="n">N</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">T</span> <span class="o">*</span> <span class="n">Ua</span> <span class="o">*</span> <span class="n">zeta</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> 
        <span class="n">term2</span> <span class="o">=</span> <span class="o">-</span> <span class="n">casadi</span><span class="o">.</span><span class="n">sum2</span><span class="p">(</span><span class="n">ds_vect</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span> <span class="n">N</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">T</span> <span class="o">*</span> <span class="p">(</span><span class="n">pf</span> <span class="o">*</span> <span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="p">]</span> <span class="o">-</span> <span class="n">X</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])))</span>
        <span class="n">term3</span> <span class="o">=</span> <span class="o">-</span> <span class="n">casadi</span><span class="o">.</span><span class="n">sum2</span><span class="p">(</span><span class="n">ds_vect</span><span class="o">.</span><span class="n">T</span> <span class="o">*</span> <span class="n">casadi</span><span class="o">.</span><span class="n">sum1</span><span class="p">(</span> <span class="p">(</span><span class="n">pa</span> <span class="o">*</span> <span class="n">theta_vals</span> <span class="o">-</span> <span class="n">pf</span> <span class="o">*</span> <span class="n">kappa</span> <span class="p">)</span> <span class="o">*</span> <span class="n">X</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span> <span class="n">gamma_size</span><span class="p">,</span> <span class="p">:]</span> <span class="p">))</span>
        
        <span class="n">opti</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span><span class="n">term1</span> <span class="o">+</span> <span class="n">term2</span> <span class="o">+</span> <span class="n">term3</span><span class="p">)</span>

        <span class="c1"># Solve optimization problem</span>
        <span class="n">options</span>               <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">options</span><span class="p">[</span><span class="s2">&quot;print_time&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">options</span><span class="p">[</span><span class="s2">&quot;expand&quot;</span><span class="p">]</span>     <span class="o">=</span> <span class="kc">True</span>
        <span class="n">options</span><span class="p">[</span><span class="s2">&quot;ipopt&quot;</span><span class="p">]</span>      <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;print_level&#39;</span><span class="p">:</span>                      <span class="mi">0</span><span class="p">,</span>
                                 <span class="s1">&#39;fast_step_computation&#39;</span><span class="p">:</span>            <span class="s1">&#39;yes&#39;</span><span class="p">,</span>
                                 <span class="s1">&#39;mu_allow_fast_monotone_decrease&#39;</span><span class="p">:</span>  <span class="s1">&#39;yes&#39;</span><span class="p">,</span>
                                 <span class="s1">&#39;warm_start_init_point&#39;</span><span class="p">:</span>            <span class="s1">&#39;yes&#39;</span><span class="p">,</span>
                                 <span class="p">}</span>
        <span class="n">opti</span><span class="o">.</span><span class="n">solver</span><span class="p">(</span><span class="s1">&#39;ipopt&#39;</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span>
        
        <span class="n">opti</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="n">ic</span><span class="p">,</span>
                       <span class="n">casadi</span><span class="o">.</span><span class="n">vertcat</span><span class="p">(</span><span class="n">site_z_vals</span><span class="p">,</span>
                                      <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">x0_vals</span><span class="p">),</span>
                                      <span class="mi">1</span><span class="p">),</span>
                       <span class="p">)</span>
        
        <span class="k">if</span> <span class="n">_DEBUG</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ic: &quot;</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;site_z_vals: &quot;</span><span class="p">,</span> <span class="n">site_z_vals</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;x0_vals: &quot;</span><span class="p">,</span> <span class="n">x0_vals</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;casadi.vertcat(site_z_vals,np.sum(x0_vals),1): &quot;</span><span class="p">,</span> <span class="n">casadi</span><span class="o">.</span><span class="n">vertcat</span><span class="p">(</span><span class="n">site_z_vals</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">x0_vals</span><span class="p">),</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">sol</span> <span class="o">=</span> <span class="n">opti</span><span class="o">.</span><span class="n">solve</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">_DEBUG</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;sol.value(X)&quot;</span><span class="p">,</span> <span class="n">sol</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">X</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;sol.value(Ua)&quot;</span><span class="p">,</span> <span class="n">sol</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">Ua</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;sol.value(Up)&quot;</span><span class="p">,</span> <span class="n">sol</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">Up</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;sol.value(Um)&quot;</span><span class="p">,</span> <span class="n">sol</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">Um</span><span class="p">))</span>
        
        
        <span class="c1">## Start Sampling</span>
        <span class="c1"># Update signature of log density evaluator</span>
        <span class="n">log_density</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">gamma_val</span><span class="p">:</span> <span class="n">log_density_function</span><span class="p">(</span><span class="n">gamma_val</span><span class="o">=</span><span class="n">gamma_val</span><span class="p">,</span>
                                                             <span class="n">gamma_vals_mean</span><span class="o">=</span><span class="n">gamma_vals_mean</span><span class="p">,</span>
                                                             <span class="n">theta_vals</span><span class="o">=</span><span class="n">theta_vals</span><span class="p">,</span>
                                                             <span class="n">site_precisions</span><span class="o">=</span><span class="n">site_precisions</span><span class="p">,</span>
                                                             <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span>
                                                             <span class="n">sol</span><span class="o">=</span><span class="n">sol</span><span class="p">,</span>
                                                             <span class="n">X</span><span class="o">=</span><span class="n">X</span><span class="p">,</span>
                                                             <span class="n">Ua</span><span class="o">=</span><span class="n">Ua</span><span class="p">,</span>
                                                             <span class="n">Up</span><span class="o">=</span><span class="n">Up</span><span class="p">,</span>
                                                             <span class="n">zbar_2017</span><span class="o">=</span><span class="n">zbar_2017</span><span class="p">,</span>
                                                             <span class="n">forestArea_2017_ha</span><span class="o">=</span><span class="n">forestArea_2017_ha</span><span class="p">,</span>
                                                             <span class="n">norm_fac</span><span class="o">=</span><span class="n">norm_fac</span><span class="p">,</span>
                                                             <span class="n">alpha_p_Adym</span><span class="o">=</span><span class="n">alpha_p_Adym</span><span class="p">,</span>
                                                             <span class="n">Bdym</span><span class="o">=</span><span class="n">Bdym</span><span class="p">,</span>
                                                             <span class="n">leng</span><span class="o">=</span><span class="n">leng</span><span class="p">,</span>
                                                             <span class="n">T</span><span class="o">=</span><span class="n">T</span><span class="p">,</span>
                                                             <span class="n">ds_vect</span><span class="o">=</span><span class="n">ds_vect</span><span class="p">,</span>
                                                             <span class="n">zeta</span><span class="o">=</span><span class="n">zeta</span><span class="p">,</span>
                                                             <span class="n">xi</span><span class="o">=</span><span class="n">xi</span><span class="p">,</span>
                                                             <span class="n">kappa</span><span class="o">=</span><span class="n">kappa</span><span class="p">,</span>
                                                             <span class="n">pa</span><span class="o">=</span><span class="n">pa</span><span class="p">,</span>
                                                             <span class="n">pf</span><span class="o">=</span><span class="n">pf</span><span class="p">,</span>
                                                             <span class="p">)</span>

        <span class="c1"># Create MCMC sampler &amp; sample, then calculate diagnostics</span>
        <span class="n">sampler</span> <span class="o">=</span> <span class="n">create_hmc_sampler</span><span class="p">(</span>
            <span class="n">size</span><span class="o">=</span><span class="n">gamma_size</span><span class="p">,</span>
            <span class="n">log_density</span><span class="o">=</span><span class="n">log_density</span><span class="p">,</span>
            <span class="c1">#</span>
            <span class="n">burn_in</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
            <span class="n">mix_in</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
            <span class="n">symplectic_integrator</span><span class="o">=</span><span class="s1">&#39;verlet&#39;</span><span class="p">,</span>
            <span class="n">symplectic_integrator_stepsize</span><span class="o">=</span><span class="mf">1e-1</span><span class="p">,</span>
            <span class="n">symplectic_integrator_num_steps</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
            <span class="n">mass_matrix</span><span class="o">=</span><span class="mf">1e+1</span><span class="p">,</span>
            <span class="n">constraint_test</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="kc">True</span> <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">x</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">)</span> <span class="k">else</span> <span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">gamma_post_samples</span> <span class="o">=</span> <span class="n">sampler</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span>
            <span class="n">sample_size</span><span class="o">=</span><span class="n">sample_size</span><span class="p">,</span>
            <span class="n">initial_state</span><span class="o">=</span><span class="n">gamma_vals</span><span class="p">,</span>
            <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">gamma_post_samples</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">gamma_post_samples</span><span class="p">)</span>

        <span class="c1"># Update ensemble/tracker</span>
        <span class="n">collected_ensembles</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">cntr</span><span class="p">:</span> <span class="n">gamma_post_samples</span><span class="o">.</span><span class="n">copy</span><span class="p">()})</span>

        <span class="c1"># Update gamma value</span>
        <span class="n">weight</span>     <span class="o">=</span> <span class="mf">0.25</span>  <span class="c1"># &lt;-- Not sure how this linear combination weighting helps!</span>
        <span class="k">if</span> <span class="n">mode_as_solution</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;We will consider this in the future; trace sampled points and keep track of objective values to pick one with highest prob. &quot;</span><span class="p">)</span>
            
        <span class="k">else</span><span class="p">:</span>
            <span class="n">gamma_vals</span> <span class="o">=</span> <span class="n">weight</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">gamma_post_samples</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span> <span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">weight</span><span class="p">)</span> <span class="o">*</span> <span class="n">gamma_vals_old</span>
        <span class="n">gamma_vals_tracker</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gamma_vals</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>

        <span class="c1"># Evaluate error for convergence check</span>
        <span class="n">error</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">gamma_vals_old</span><span class="o">-</span><span class="n">gamma_vals</span><span class="p">)</span> <span class="o">/</span> <span class="n">gamma_vals_old</span><span class="p">)</span>
        <span class="n">error_tracker</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Iteration [</span><span class="si">{</span><span class="n">cntr</span><span class="o">+</span><span class="mi">1</span><span class="si">:</span><span class="s2">4d</span><span class="si">}</span><span class="s2">]: Error = </span><span class="si">{</span><span class="n">error</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Exchange gamma values (for future weighting/update &amp; error evaluation)</span>
        <span class="n">gamma_vals_old</span> <span class="o">=</span> <span class="n">gamma_vals</span>

        <span class="c1"># Increase the counter</span>
        <span class="n">cntr</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">results</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;cntr&#39;</span><span class="p">:</span> <span class="n">cntr</span><span class="p">,</span>
                        <span class="s1">&#39;error_tracker&#39;</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">error_tracker</span><span class="p">),</span>
                        <span class="s1">&#39;gamma_vals_tracker&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">gamma_vals_tracker</span><span class="p">),</span>
                        <span class="s1">&#39;collected_ensembles&#39;</span><span class="p">:</span><span class="n">collected_ensembles</span><span class="p">,</span>
                        <span class="p">})</span>
        <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;results.pcl&#39;</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">))</span>
        
        <span class="c1"># Extensive plotting for monitoring; not needed really!</span>
        <span class="k">if</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">gamma_vals_tracker</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;Old $\gamma$&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">gamma_vals_tracker</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;New $\gamma$&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">gamma_size</span><span class="p">):</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">gamma_post_samples</span><span class="p">[:,</span> <span class="n">j</span><span class="p">],</span> <span class="n">bins</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Iteration </span><span class="si">{</span><span class="n">cntr</span><span class="si">}</span><span class="s2">; Site </span><span class="si">{</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Terminated. Sampling the final distribution&quot;</span><span class="p">)</span>
    <span class="c1"># Sample (densly) the final distribution</span>
    <span class="n">final_sample</span> <span class="o">=</span> <span class="n">sampler</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span>
        <span class="n">sample_size</span><span class="o">=</span><span class="n">final_sample_size</span><span class="p">,</span>
        <span class="n">initial_state</span><span class="o">=</span><span class="n">gamma_vals</span><span class="p">,</span>
        <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">final_sample</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">final_sample</span><span class="p">)</span>
    <span class="n">results</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;final_sample&#39;</span><span class="p">:</span> <span class="n">final_sample</span><span class="p">})</span>
    <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;results.pcl&#39;</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">))</span>
    
    <span class="k">return</span> <span class="n">results</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">results</span> <span class="o">=</span> <span class="n">main</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>******************************************************************************
This program contains Ipopt, a library for large-scale nonlinear optimization.
 Ipopt is released as open source code under the Eclipse Public License (EPL).
         For more information visit https://github.com/coin-or/Ipopt
******************************************************************************
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>=====================================================
Started Sampling
=====================================================
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>HMC Iteration [   1/2100]; Accept Prob: 1.00; --&gt; Accepted? True  
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>HMC Iteration [   2/2100]; Accept Prob: 1.00; --&gt; Accepted? True  
</pre></div>
</div>
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NotImplementedError</span><span class="g g-Whitespace">                       </span>Traceback (most recent call last)
<span class="nn">File ~/.local/lib/python3.9/site-packages/casadi/casadi.py:11062,</span> in <span class="ni">DM.toarray</span><span class="nt">(self, simplify)</span>
<span class="g g-Whitespace">  </span><span class="mi">11061</span> <span class="k">if</span> <span class="n">simplify</span><span class="p">:</span>
<span class="ne">&gt; </span><span class="mi">11062</span>   <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_scalar</span><span class="p">():</span>
<span class="g g-Whitespace">  </span><span class="mi">11063</span>     <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

<span class="nn">File ~/.local/lib/python3.9/site-packages/casadi/casadi.py:4580,</span> in <span class="ni">GenDM.is_scalar</span><span class="nt">(self, *args)</span>
<span class="g g-Whitespace">   </span><span class="mi">4559</span><span class="w"> </span><span class="sd">&quot;&quot;&quot;</span>
<span class="g g-Whitespace">   </span><span class="mi">4560</span><span class="sd">   [INTERNAL] </span>
<span class="g g-Whitespace">   </span><span class="mi">4561</span><span class="sd"> </span>
<span class="sd">   (...)</span>
<span class="g g-Whitespace">   </span><span class="mi">4578</span><span class="sd"> </span>
<span class="g g-Whitespace">   </span><span class="mi">4579</span><span class="sd"> &quot;&quot;&quot;</span>
<span class="ne">-&gt; </span><span class="mi">4580</span> <span class="k">return</span> <span class="n">_casadi</span><span class="o">.</span><span class="n">GenDM_is_scalar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>

<span class="ne">NotImplementedError</span>: Wrong number or type of arguments for function &#39;GenDM_is_scalar&#39;.
  <span class="n">Prototype</span><span class="p">:</span>
<span class="n">is_scalar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="nb">bool</span><span class="p">)</span>
  <span class="n">You</span> <span class="n">have</span><span class="p">:</span> <span class="s1">&#39;(DM)&#39;</span>


<span class="n">The</span> <span class="n">above</span> <span class="n">exception</span> <span class="n">was</span> <span class="n">the</span> <span class="n">direct</span> <span class="n">cause</span> <span class="n">of</span> <span class="n">the</span> <span class="n">following</span> <span class="n">exception</span><span class="p">:</span>

<span class="ne">SystemError</span><span class="g g-Whitespace">                               </span>Traceback (most recent call last)
<span class="nn">Input In [8],</span> in <span class="ni">&lt;cell line: 1&gt;</span><span class="nt">()</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">results</span> <span class="o">=</span> <span class="n">main</span><span class="p">()</span>

<span class="nn">Input In [7],</span> in <span class="ni">main</span><span class="nt">(norm_fac, delta_t, alpha, kappa, pf, pa, xi, zeta, max_iter, tol, T, N, sample_size, mode_as_solution, final_sample_size)</span>
<span class="g g-Whitespace">    </span><span class="mi">249</span> <span class="c1"># Create MCMC sampler &amp; sample, then calculate diagnostics</span>
<span class="g g-Whitespace">    </span><span class="mi">250</span> <span class="n">sampler</span> <span class="o">=</span> <span class="n">create_hmc_sampler</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">251</span>     <span class="n">size</span><span class="o">=</span><span class="n">gamma_size</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">252</span>     <span class="n">log_density</span><span class="o">=</span><span class="n">log_density</span><span class="p">,</span>
   <span class="p">(</span><span class="o">...</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">260</span>     <span class="n">constraint_test</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="kc">True</span> <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">x</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">)</span> <span class="k">else</span> <span class="kc">False</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">261</span> <span class="p">)</span>
<span class="ne">--&gt; </span><span class="mi">262</span> <span class="n">gamma_post_samples</span> <span class="o">=</span> <span class="n">sampler</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">263</span>     <span class="n">sample_size</span><span class="o">=</span><span class="n">sample_size</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">264</span>     <span class="n">initial_state</span><span class="o">=</span><span class="n">gamma_vals</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">265</span>     <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">266</span> <span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">267</span> <span class="n">gamma_post_samples</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">gamma_post_samples</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">269</span> <span class="c1"># Update ensemble/tracker</span>

<span class="nn">File /project/lhansen/HMC_book/Amazon/models/amazon_mhpy/mcmc/mcmc_sampling.py:545,</span> in <span class="ni">HMCSampler.sample</span><span class="nt">(self, sample_size, verbose, initial_state)</span>
<span class="g g-Whitespace">    </span><span class="mi">540</span> <span class="k">def</span> <span class="nf">sample</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sample_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">initial_state</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="p">):</span>
<span class="g g-Whitespace">    </span><span class="mi">541</span><span class="w">     </span><span class="sd">&quot;&quot;&quot;</span>
<span class="g g-Whitespace">    </span><span class="mi">542</span><span class="sd">     Generate and return a sample of size `sample_size`.</span>
<span class="g g-Whitespace">    </span><span class="mi">543</span><span class="sd">     This method returns a list with each entry representing a sample point from the underlying distribution</span>
<span class="g g-Whitespace">    </span><span class="mi">544</span><span class="sd">     &quot;&quot;&quot;</span>
<span class="ne">--&gt; </span><span class="mi">545</span>     <span class="n">hmc_results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_HMC_sampling</span><span class="p">(</span><span class="n">sample_size</span><span class="o">=</span><span class="n">sample_size</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span> <span class="n">initial_state</span><span class="o">=</span><span class="n">initial_state</span><span class="p">,</span> <span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">546</span>     <span class="k">return</span> <span class="n">hmc_results</span><span class="p">[</span><span class="s1">&#39;collected_ensemble&#39;</span><span class="p">]</span>

<span class="nn">File /project/lhansen/HMC_book/Amazon/models/amazon_mhpy/mcmc/mcmc_sampling.py:891,</span> in <span class="ni">HMCSampler.start_HMC_sampling</span><span class="nt">(self, sample_size, initial_state, randomize_step_size, verbose)</span>
<span class="g g-Whitespace">    </span><span class="mi">888</span> <span class="n">current_momentum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass_matrix_sqrt_matvec</span><span class="p">(</span><span class="n">current_momentum</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">890</span> <span class="c1"># Advance the current state and momentum to propose a new pair:</span>
<span class="ne">--&gt; </span><span class="mi">891</span> <span class="n">proposed_momentum</span><span class="p">,</span> <span class="n">proposed_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_symplectic_integration</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">892</span>     <span class="n">momentum</span><span class="o">=</span><span class="n">current_momentum</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">893</span>     <span class="n">state</span><span class="o">=</span><span class="n">current_state</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">894</span>     <span class="n">num_steps</span><span class="o">=</span><span class="n">hamiltonian_num_steps</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">895</span>     <span class="n">step_size</span><span class="o">=</span><span class="n">hamiltonian_step_size</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">896</span>     <span class="n">randomize_step_size</span><span class="o">=</span><span class="n">randomize_step_size</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">897</span>     <span class="n">symplectic_integrator</span><span class="o">=</span><span class="n">symplectic_integrator</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">898</span> <span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">900</span> <span class="c1"># print(&quot;proposed_momentum, proposed_state&quot;, proposed_momentum, proposed_state)</span>
<span class="g g-Whitespace">    </span><span class="mi">901</span> 
<span class="g g-Whitespace">    </span><span class="mi">902</span> <span class="c1">## MH step (Accept/Reject) proposed (momentum, state)</span>
<span class="g g-Whitespace">    </span><span class="mi">903</span> <span class="c1"># Calculate acceptance proabability</span>
<span class="g g-Whitespace">    </span><span class="mi">904</span> <span class="c1"># Total energy (Hamiltonian) of the extended pair (proposed_momentum,</span>
<span class="g g-Whitespace">    </span><span class="mi">905</span> <span class="c1"># Here, we evaluate the kernel of the posterior at both the current and the proposed state proposed_state)</span>
<span class="g g-Whitespace">    </span><span class="mi">906</span> <span class="n">current_energy</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">total_Hamiltonian</span><span class="p">(</span><span class="n">momentum</span><span class="o">=</span><span class="n">current_momentum</span><span class="p">,</span> <span class="n">state</span><span class="o">=</span><span class="n">current_state</span><span class="p">)</span>

<span class="nn">File /project/lhansen/HMC_book/Amazon/models/amazon_mhpy/mcmc/mcmc_sampling.py:774,</span> in <span class="ni">HMCSampler.apply_symplectic_integration</span><span class="nt">(self, momentum, state, step_size, num_steps, randomize_step_size, symplectic_integrator)</span>
<span class="g g-Whitespace">    </span><span class="mi">770</span> <span class="n">proposed_state</span> <span class="o">=</span> <span class="n">current_state</span> <span class="o">+</span> <span class="p">(</span><span class="mf">0.5</span><span class="o">*</span><span class="n">h</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass_matrix_inv_matvec</span><span class="p">(</span><span class="n">current_momentum</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">771</span> <span class="c1"># print(&quot;1: proposed state&quot;, proposed_state)</span>
<span class="g g-Whitespace">    </span><span class="mi">772</span> 
<span class="g g-Whitespace">    </span><span class="mi">773</span> <span class="c1"># Update momentum</span>
<span class="ne">--&gt; </span><span class="mi">774</span> <span class="n">grad</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">potential_energy_grad</span><span class="p">(</span><span class="n">proposed_state</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">775</span> <span class="n">proposed_momentum</span> <span class="o">=</span> <span class="n">current_momentum</span> <span class="o">-</span> <span class="n">h</span> <span class="o">*</span> <span class="n">grad</span>
<span class="g g-Whitespace">    </span><span class="mi">776</span> <span class="c1"># print(&quot;&lt;: proposed momentum&quot;, proposed_momentum)</span>
<span class="g g-Whitespace">    </span><span class="mi">777</span> 
<span class="g g-Whitespace">    </span><span class="mi">778</span> <span class="c1"># Update state again</span>

<span class="nn">File /project/lhansen/HMC_book/Amazon/models/amazon_mhpy/mcmc/mcmc_sampling.py:653,</span> in <span class="ni">HMCSampler.potential_energy_grad</span><span class="nt">(self, state, verbose)</span>
<span class="g g-Whitespace">    </span><span class="mi">651</span>     <span class="c1"># raise ValueError</span>
<span class="g g-Whitespace">    </span><span class="mi">652</span>     <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
<span class="ne">--&gt; </span><span class="mi">653</span> <span class="k">return</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">log_density_grad</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>

<span class="nn">File /project/lhansen/HMC_book/Amazon/models/amazon_mhpy/mcmc/mcmc_sampling.py:625,</span> in <span class="ni">HMCSampler.log_density_grad</span><span class="nt">(self, state)</span>
<span class="g g-Whitespace">    </span><span class="mi">621</span> <span class="k">def</span> <span class="nf">log_density_grad</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
<span class="g g-Whitespace">    </span><span class="mi">622</span><span class="w">     </span><span class="sd">&quot;&quot;&quot;</span>
<span class="g g-Whitespace">    </span><span class="mi">623</span><span class="sd">     Evaluate the gradient of the logarithm of the target unscaled posterior density function</span>
<span class="g g-Whitespace">    </span><span class="mi">624</span><span class="sd">     &quot;&quot;&quot;</span>
<span class="ne">--&gt; </span><span class="mi">625</span>     <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_LOG_DENSITY_GRAD</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>

<span class="nn">File /project/lhansen/HMC_book/Amazon/models/amazon_mhpy/mcmc/mcmc_sampling.py:363,</span> in <span class="ni">HMCSampler.__create_func_grad.&lt;locals&gt;.func_grad</span><span class="nt">(x, fd_eps, fd_central)</span>
<span class="g g-Whitespace">    </span><span class="mi">361</span>         <span class="n">grad</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">func</span><span class="p">(</span><span class="n">x</span><span class="o">+</span><span class="n">e</span><span class="p">)</span> <span class="o">-</span> <span class="n">func</span><span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="n">e</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">fd_eps</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">362</span>     <span class="k">else</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">363</span>         <span class="n">grad</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">func</span><span class="p">(</span><span class="n">x</span><span class="o">+</span><span class="n">e</span><span class="p">)</span> <span class="o">-</span> <span class="n">func</span><span class="p">(</span><span class="n">x</span><span class="p">))</span> <span class="o">/</span> <span class="n">fd_eps</span>
<span class="g g-Whitespace">    </span><span class="mi">364</span> <span class="k">return</span> <span class="n">grad</span>

<span class="nn">Input In [7],</span> in <span class="ni">main.&lt;locals&gt;.&lt;lambda&gt;</span><span class="nt">(gamma_val)</span>
<span class="g g-Whitespace">    </span><span class="mi">220</span>     <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;sol.value(Um)&quot;</span><span class="p">,</span> <span class="n">sol</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">Um</span><span class="p">))</span>
<span class="g g-Whitespace">    </span><span class="mi">223</span> <span class="c1">## Start Sampling</span>
<span class="g g-Whitespace">    </span><span class="mi">224</span> <span class="c1"># Update signature of log density evaluator</span>
<span class="ne">--&gt; </span><span class="mi">225</span> <span class="n">log_density</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">gamma_val</span><span class="p">:</span> <span class="n">log_density_function</span><span class="p">(</span><span class="n">gamma_val</span><span class="o">=</span><span class="n">gamma_val</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">226</span>                                                      <span class="n">gamma_vals_mean</span><span class="o">=</span><span class="n">gamma_vals_mean</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">227</span>                                                      <span class="n">theta_vals</span><span class="o">=</span><span class="n">theta_vals</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">228</span>                                                      <span class="n">site_precisions</span><span class="o">=</span><span class="n">site_precisions</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">229</span>                                                      <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">230</span>                                                      <span class="n">sol</span><span class="o">=</span><span class="n">sol</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">231</span>                                                      <span class="n">X</span><span class="o">=</span><span class="n">X</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">232</span>                                                      <span class="n">Ua</span><span class="o">=</span><span class="n">Ua</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">233</span>                                                      <span class="n">Up</span><span class="o">=</span><span class="n">Up</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">234</span>                                                      <span class="n">zbar_2017</span><span class="o">=</span><span class="n">zbar_2017</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">235</span>                                                      <span class="n">forestArea_2017_ha</span><span class="o">=</span><span class="n">forestArea_2017_ha</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">236</span>                                                      <span class="n">norm_fac</span><span class="o">=</span><span class="n">norm_fac</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">237</span>                                                      <span class="n">alpha_p_Adym</span><span class="o">=</span><span class="n">alpha_p_Adym</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">238</span>                                                      <span class="n">Bdym</span><span class="o">=</span><span class="n">Bdym</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">239</span>                                                      <span class="n">leng</span><span class="o">=</span><span class="n">leng</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">240</span>                                                      <span class="n">T</span><span class="o">=</span><span class="n">T</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">241</span>                                                      <span class="n">ds_vect</span><span class="o">=</span><span class="n">ds_vect</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">242</span>                                                      <span class="n">zeta</span><span class="o">=</span><span class="n">zeta</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">243</span>                                                      <span class="n">xi</span><span class="o">=</span><span class="n">xi</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">244</span>                                                      <span class="n">kappa</span><span class="o">=</span><span class="n">kappa</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">245</span>                                                      <span class="n">pa</span><span class="o">=</span><span class="n">pa</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">246</span>                                                      <span class="n">pf</span><span class="o">=</span><span class="n">pf</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">247</span>                                                      <span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">249</span> <span class="c1"># Create MCMC sampler &amp; sample, then calculate diagnostics</span>
<span class="g g-Whitespace">    </span><span class="mi">250</span> <span class="n">sampler</span> <span class="o">=</span> <span class="n">create_hmc_sampler</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">251</span>     <span class="n">size</span><span class="o">=</span><span class="n">gamma_size</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">252</span>     <span class="n">log_density</span><span class="o">=</span><span class="n">log_density</span><span class="p">,</span>
   <span class="p">(</span><span class="o">...</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">260</span>     <span class="n">constraint_test</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="kc">True</span> <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">x</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">)</span> <span class="k">else</span> <span class="kc">False</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">261</span> <span class="p">)</span>

<span class="nn">Input In [6],</span> in <span class="ni">log_density_function</span><span class="nt">(gamma_val, gamma_vals_mean, theta_vals, site_precisions, alpha, sol, X, Ua, Up, zbar_2017, forestArea_2017_ha, norm_fac, alpha_p_Adym, Bdym, leng, T, ds_vect, zeta, xi, kappa, pa, pf)</span>
<span class="g g-Whitespace">     </span><span class="mi">35</span> <span class="n">X_zero</span>     <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">x0_vals</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">leng</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">38</span> <span class="c1"># shifted_X = zbar_2017 - sol.value(X)[0:gamma_size, :-1]</span>
<span class="ne">---&gt; </span><span class="mi">39</span> <span class="n">shifted_X</span>  <span class="o">=</span> <span class="n">sol</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">X</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span> <span class="n">gamma_size</span><span class="p">,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="g g-Whitespace">     </span><span class="mi">40</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span> 
<span class="g g-Whitespace">     </span><span class="mi">41</span>     <span class="n">shifted_X</span><span class="p">[:,</span> <span class="n">j</span><span class="p">]</span>  <span class="o">=</span> <span class="n">zbar_2017</span> <span class="o">-</span> <span class="n">shifted_X</span><span class="p">[:,</span> <span class="n">j</span><span class="p">]</span>

<span class="nn">File ~/.local/lib/python3.9/site-packages/casadi/casadi.py:50275,</span> in <span class="ni">OptiSol.value</span><span class="nt">(self, *args)</span>
<span class="g g-Whitespace">  </span><span class="mi">50139</span> <span class="k">def</span> <span class="nf">value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;casadi::native_DM&quot;</span><span class="p">:</span>
<span class="g g-Whitespace">  </span><span class="mi">50140</span><span class="w">     </span><span class="sd">&quot;&quot;&quot;</span>
<span class="g g-Whitespace">  </span><span class="mi">50141</span><span class="sd">       [INTERNAL] </span>
<span class="g g-Whitespace">  </span><span class="mi">50142</span><span class="sd"> </span>
<span class="sd">   (...)</span>
<span class="g g-Whitespace">  </span><span class="mi">50273</span><span class="sd"> </span>
<span class="g g-Whitespace">  </span><span class="mi">50274</span><span class="sd">     &quot;&quot;&quot;</span>
<span class="ne">&gt; </span><span class="mi">50275</span>     <span class="k">return</span> <span class="n">_casadi</span><span class="o">.</span><span class="n">OptiSol_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>

<span class="ne">SystemError</span>: &lt;built-in function OptiSol_value&gt; returned a result with an error set
</pre></div>
</div>
</div>
</div>
<section id="plot-results">
<h2>Plot Results<a class="headerlink" href="#plot-results" title="Permalink to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Plot Error Results</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;error_tracker&#39;</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Iteration&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Error&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Plot Gamma Estimate Update</span>
<span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;gamma_size&#39;</span><span class="p">]):</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;gamma_vals_tracker&#39;</span><span class="p">][:,</span> <span class="n">j</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;$\gamma_{</span><span class="si">%d</span><span class="s2">}$&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">1.04</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">),</span> <span class="n">loc</span><span class="o">=</span><span class="s2">&quot;center left&quot;</span><span class="p">,</span> <span class="n">borderaxespad</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Plot Histograms</span>
<span class="k">for</span> <span class="n">itr</span> <span class="ow">in</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;collected_ensembles&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;gamma_size&#39;</span><span class="p">]):</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;collected_ensembles&#39;</span><span class="p">][</span><span class="n">itr</span><span class="p">][:,</span> <span class="n">j</span><span class="p">],</span> <span class="n">bins</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Iteration </span><span class="si">{</span><span class="n">itr</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">; Site </span><span class="si">{</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Plot Histogram of the final sample</span>
<span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;gamma_size&#39;</span><span class="p">]):</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;final_sample&#39;</span><span class="p">][:,</span> <span class="n">j</span><span class="p">],</span> <span class="n">bins</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Final Sample; Site </span><span class="si">{</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./models/amazon_mhpy"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer">
                  
<div class="prev-next-area">
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#">Multivariate Normal Log Probability</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#load-site-data-function">Load Site Data Function</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#log-density-function">Log Density Function</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#description-of-the-main-function">Description of the <code class="docutils literal notranslate"><span class="pre">main</span></code> Function</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#parameters-of-the-function">Parameters of the Function</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#core-function-logic">Core Function Logic</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#hamiltonian-monte-carlo">Hamiltonian Monte Carlo</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#plot-results">Plot Results</a></li>
</ul>
</li>
</ul>

  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By The Jupyter Book Community
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2022.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/bootstrap.js?digest=bd9e20870c6007c4c509"></script>
<script src="../../_static/scripts/pydata-sphinx-theme.js?digest=bd9e20870c6007c4c509"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>